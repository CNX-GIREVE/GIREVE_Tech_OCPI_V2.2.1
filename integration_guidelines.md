# Contents

* [Technical](#technical)
  - Supported OCPI versions
  - Security
  - Platform and operator identification
  - Traceability: X-Correlation-ID and X-Request-ID
  - Multi-tenant and multi-role capability
  - IOP is a “HUB”
  - Client owned object push
  - Pagination
  - Pulling Limits
  - List of OCPI Modules
  - Gireve management of Ids
  
* [Gireve management of Locations data](#gireve-management-of-locations-data)
* [Roaming](#roaming)
  - General workflow
  - Management of B2B tariffs
  - RFID Tokens
 
*** 

# `Technical`

### Supported OCPI versions

IOP OCPI implementation supports two versions : 
-   OCPI 2.1.1
-   OCPI 2.2.1


### Security

IOP follows the security standard mechanisms of OCPI. To set up a connection with a new platform, Gireve provides connecting platform with a temporary Token to register. The Token should be used when the connection is initiated by the platform.
In the meantime, the platform can provide Gireve with temporary Token for IOP to initiate the connection. It is not mandatory as the platform is able to launch the Connection & Register process.
During the Connection & Register process, IOP and the platform exchange final Tokens to request each other, and endpoints of their respective OCPI modules. 

#### Information and Requirements

-   Contrary to OCPI 2.1.1, an OCPI 2.2.1 connection is multi-tenant and multi-role. 
This means that through a unique connection (i.e. OCPI Handshake) between a platform and IOP, every operator hosted by the platform can communicate with IOP, whatever their role.
-   OCPI 2.2.1 requires the Authorization token, sent in headers of every request, to be encoded in base 64.
-   Gireve requires all endpoints to be in HTTPS to secure communication between the partner and IOP.
-   To secure data exchanges, IOP has an IP filtering for incoming requests.
-   To increase security, Gireve is able to configure authentication via SSL client certificate on both ways. 
Client certificate used by the partner to request IOP is generated by Gireve.
Client certificate used by IOP to request the partner shall be provided by the partner.


### Platform and operator identification

OCPI is a protocol enabling the communication between operators (CPO, eMSP, …). 
These operators are technically managed by OCPI platforms.
OCPI platforms are interconnected.
This means that when an operator requests another operator through OCPI, the request must contain the identifiers of the platform that requests, the operator that requests and the operator that is requested.

<ins>Information in request used for identification :</ins>

| Identification of the platform that requests | Identification of the operator that requests |	Identification of the requested operator |
| ----------- | ----------- | ----------- |
| Authorization Token | Headers-From | Headers-To |


#### Information and Requirements

-   The Credentials module and flows are used to manage the OCPI connection between 2 platforms. It doesn’t require the usage of Headers-From and Headers-To.
-   The usage of Headers-To and Headers-From is mandatory for Gireve, except for Credentials module.
-   Every request shall be sent to IOP operator, using the headers-To. IOP role as a “HUB” is to dispatch the information to other operators. 

### Traceability: X-Correlation-ID and X-Request-ID

| Attributes | Description |
| ----------- | ----------- |
| **X-Request-ID**  | Every request SHALL contain a unique request ID, the response to this request SHALL contain the same ID. The request ID is the ID of an exchange between two OCPI platforms. |
| **X-Correlation-ID** | Every request SHALL contain a unique correlation ID, every response to this request SHALL contain the same ID. The correlation ID is an ID enabling to trace a first request then all exchanges that are “consequences of the first request. Example: an exchange between a CPO and IOP to update an EVSE status has the same correlation ID as all exchanges between IOP and eMSPs to forward this status update. |


#### Information and Requirements

-   Every request sent by a partner to Gireve shall contain a X-Request-ID and a X-Correlation-ID.
-   When IOP requests a platform, the platform shall respond using the same X-Request-ID and X-Correlation-ID values. 
-   Gireve suggests generating and using a UUID for X-Correlation-ID and X-Request-ID values.


### Multi-tenant and multi-role capability

An OCPI 2.2.1 connection (i.e. OCPI Handshake) can be used to enable multiple operators to communicate, regardless of their roles. 

#### Information and Requirements

-   Only 1 OCPI handshake is needed to initialise the connection and enable the communication between several operators hosted by a unique platform and IOP. 
-   Gireve configures on its own the roles of an operator and rejects forbidden requests.
Example: If the operator is configured as eMSP only and requests the interface “CDRs Receiver” of IOP, the request is rejected.

### IOP is a “HUB”

Gireve presents the role “HUB” during the Credentials process. A “HUB”, more than a single operator, processes and forwards the incoming request to appropriate targets.
Moreover, IOP as a “HUB”, filters and cleans requests between operators.
Examples:
If a CPO is in roaming agreement with X eMSPs through Gireve, the CPO sends only 1 EVSE status update to IOP, then IOP forwards the information to the X eMSPs.
If a CPO sends several times in a row the same EVSE status for an EVSE, IOP takes into account and forwards the first, but ignores the following ones.

#### Information and Requirements
-   IOP country_code is “FR”. Its party_id is “107” on PreProduction and “007” on Production.
-   Every request shall be sent to IOP operator, using the headers-To. IOP role as a “HUB” is to dispatch the information to other operators. 

### Client owned object push

OCPI introduces a specific use of resource identification mechanism, to manage situations where resource belongs to servers and situations where resource belongs to clients. [See OCPI client owned object.](https://github.com/ocpi/ocpi/blob/release-2.2.1-bugfixes/transport_and_format.asciidoc)
In OCPI 2.2.1, Objects managed through Rest protocol are owned by a CPO, an eMSP, a SCSP or a HUB.
In the same way, for OCPI 2.2.1, there are two « interfaces »: Sender/Receiver. 

| Module | Who is owner | Who could implement sender interface | Who could implement receiver interface |
| ----------- | ----------- | ----------- | ----------- |
| Credentials | NA | An OCPI platform | An OCPI platform |
| Locations | CPO, NAP | CPO, NAP, HUB | All roles except CPO |
| Tokens | EMSP | EMSP, HUB | All roles except EMSP |
| Commands | NA | EMSP, SCSP, HUB | All roles except EMSP |
| Sessions | CPO | CPO, HUB | All roles except CPO |
| CDRs | CPO | CPO, HUB | All roles except CPO |
| Tariffs | CPO | CPO, HUB | All roles except CPO |
| ChargingProfiles | EMSP, SCSP | EMSP, SCSP, HUB | All roles |
| HubClientInfo | HUB | HUB | All roles |

#### Information and Requirements

-   Connected to IOP, a platform can receive objects owned by operators behind IOP. The country_code and party_id of the object owner, in the URL and in the object, are the object owner ones.

### Pagination

IOP implements pagination mechanisms described by OCPI. [See OCPI pagination mechanism.](https://github.com/ocpi/ocpi/blob/release-2.1.1-bugfixes/transport_and_format.md#pagination)
IOP requires operators to use pagination when they pull resources requesting IOP. If the operator does not use pagination arguments in its request, IOP will force it answering with the first X items and a Link to the second page if any.


### Pulling Limits

For each module, IOP has its own max size limit per page. These limits can change with IOP evolutions, the operator implementation might be flexible regarding these limits.

#### Information and Requirements
•	At the moment, IOP limits pulled objects to:
o	Locations module: 100 objects per page
o	Tokens module: 1000 objects per page
o	CDRs module: 20 objects per page
o	Tariffs module: 100 objects per page

### List of OCPI Modules

| Module | Usage | Implemented by Gireve (Yes, No)|
| ----------- | ----------- | ----------- |
| Credentials |Initialise and update IT connection information (endpoints, OCPI versions, …)| Yes |
| Locations | Transfer charge infrastructure information | Yes |
| Tokens | Transfer tokens and process Local authorizations | Yes |
| Commands | Send Commands to CPO (remote start, booking, …) | Yes |
| Sessions | Transfer information during charge | Yes |
| CDRs | Transfer the final charge detail report | Yes |
| Tariffs | Transfer tariff descriptions | Yes |
| ChargingProfiles | Transfer charging profiles (smart charge feature) | No |
| HubClientInfo | Transfer information about connection status to Hub | No |

#### Information and Requirements
-   Gireve, in its 1st version of OCPI 2.2.1, has implemented required features for CPOs and eMSPs to do roaming through OCPI 2.2.1. The scope implemented increases with time, updates are published in Gireve release notes and as updates in this document.

### Gireve management of Ids

In its OCPI 2.1.1 implementation, Gireve replaces Object Ids sent by object owners by Ids managed by Gireve when objects are transferred to other parties. This transformation is required to ensure Ids unicity.
Example: An eMSP doesn’t receive 2 Locations having the same Id if 2 CPOs connected to Gireve identify a Location with the same Id.
Thanks to OCPI 2.2.1 and the adding of object owner identifier in all objects (i.e. “country_code” and “party_id”), parties connected to Gireve in OCPI 2.2.1 receive Ids as sent by object owners in most modules. 

Nevertheless, Gireve decides to extend Locations and Tariffs with “gireve_id” property to easier migrations of partners connected through eMIP or OCPI 2.1.1 and which would like to connect on OCPI 2.2.1.

| Module | Object Id transferred to receiver in OCPI 2.1.1 | Object Id transferred to receiver in OCPI 2.2.1 | More information |
| ----------- | ----------- | ----------- | ----------- |
| Locations | Gireve internal Id (i.e. “gireve_id”) | Object owner Id | Location object is extended with “gireve_id” when transferred to a receiver party. |
| Sessions | Gireve internal Id (i.e. “gireve_id”) | Yes | Gireve internal Id is used in Gireve ecosystem, including the Gireve connect place, to identify a charging session. |
| CDRs | Object owner Id | Yes | - |
| Tariffs | Object owner Id | Tariff object is extended with “gireve_id” when transferred to a receiver party. | 

# `Gireve management of Locations data`

Gireve and its systems distinguish two natures of Location properties:
•	Static data: Locations properties which almost never change.
•	Dynamic data: Locations properties which can change frequently (e.g., EVSE status, Connector tariff_ids)
All Location properties are considered as static data except for the status of the EVSE, except “REMOVED” and “PLANNED” status, and the tariff_ids attached to a connector.

#### Information and Requirements
-   GIREVE performs a specific process to first integrate static data of CPO Locations in its charge point repository then to integrate static data changes like changes on a Location of a CPO or new Locations or EVSEs. This process implies data quality tests and data completion of the CPO Locations. This process is asynchronous from the standard connection of the CPO with Gireve’s IOP platform, meaning that new Locations of the CPO or updates on them can be seen in the Gireve charge point repository several hours after the first PUSH from the CPO to the Gireve IOP platform.


# `Roaming`


### General workflow

An OCPI Roaming session through IOP should run the following workflow :

#### Authorisation then initialise Session object

![image](https://github.com/CNX-GIREVE/GIRVE_Tech_OCPI_V2.1.1/assets/137178502/b31cb733-abe7-420c-8784-ddba1d846a46)

#### Session status information exchange, stop then Charge Detail Record

![image](https://github.com/CNX-GIREVE/GIRVE_Tech_OCPI_V2.1.1/assets/137178502/ac509c35-6d0b-4e82-b83a-048aa302c283)

## `Management of B2B tariffs`

The CPO connected to Gireve through OCPI have two options to manage and “publish” B2B tariffs:

**<ins>B2B tariffs are described in roaming agreements :</ins>** The description and the commitment related to tariffs are contained in roaming agreements signed on Gireve Connect Place :

-   Tariffs applied for a contract between an eMSP and a CPO are defined and negotiated, using the Gireve Connect Place, before signature of the roaming agreement by both parties.
-   In case of tariff updates, the CPO and the eMSP must sign an amendment whose management is fully automated.

<ins>In this case (tariffs defined in roaming agreements), the CPO should not use the OCPI Tariffs module.</ins>

**<ins>B2B tariffs are not described in roaming agreements :</ins>** Tariffs are not described in roaming agreements and the CPO transfers them through the OCPI Tariffs module.

-   In this case, the CPO manages its tariffs on its own and eMSPs cannot give their insights or validation about applied tariffs.
-   In case of tariff updates, the CPO and the eMSP do not need to sign an amendment.
  
#### Information and Requirements
-   Currently, Gireve has not implemented OCPI 2.2.1 smart charge use-cases. CPOs can send their “FAST”, “CHEAP” and “GREEN” tariffs, but they are not transferred to eMSPs.
-   “Ad Hoc” tariffs sent by CPOs are not transferred to eMSPs either.

## `RFID Tokens`

The current typical situation for identification is swiping a MIFARE badge. In this case, the relevant RFID tag in such a situation is a character string that shall contain the hexadecimal representation of the 4- or 7-bytes RFID UID (sector 0). Please note that the 7 bytes UID is preferred for interoperability reasons.

As an example: “1A2B3C4D5E6F70” shall be interpreted as

-   Lowest address byte contains “1A” and “1” is the most significant nibble (half byte) and “A” is the least significant nibble.
-   Highest address byte contains “70”
-   Equivalent decimal value is “7365887390543728”

The RFID is not case sensitive. We recommend using uppercase characters. Leading zeros must be provided to reach 8 characters in case of 4 bytes UID or 14 characters in case of 7 bytes UID.

#### Information and Requirements
-  For safety reasons, IOP rejects requests done with a bad RFID UID format.
